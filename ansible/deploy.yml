---
# Ansible playbook for deploying the application
# Usage: ansible-playbook ansible/deploy.yml

- name: Deploy Streamline Scheduler to VPS
  hosts: production
  become: yes
  gather_facts: yes

  tasks:
    - name: Install rsync on VPS
      ansible.builtin.package:
        name: rsync
        state: present
      tags: [deploy, setup]

    - name: Ensure application directory exists
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'
      tags: [deploy]

    - name: Copy application files to VPS
      ansible.posix.synchronize:
        src: "{{ playbook_dir }}/../"
        dest: "{{ app_dir }}/"
        delete: yes
        recursive: yes
        rsync_opts:
          - "--exclude=.git"
          - "--exclude=node_modules"
          - "--exclude=.next"
          - "--exclude=.env*"
          - "--exclude=ansible"
        dest_port: "{{ ansible_port }}"
      tags: [deploy]

    - name: Create .env file for Docker Compose
      template:
        src: templates/env.production.j2
        dest: "{{ app_dir }}/.env"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'
      tags: [deploy, env]

    - name: Ensure Docker is installed
      ansible.builtin.package:
        name: docker.io
        state: present
      tags: [deploy, docker, setup]

    - name: Install docker-compose v2
      ansible.builtin.get_url:
        url: https://github.com/docker/compose/releases/download/v2.32.4/docker-compose-linux-x86_64
        dest: /usr/local/bin/docker-compose
        mode: '0755'
      tags: [deploy, docker, setup]

    - name: Create Docker CLI plugins directory
      ansible.builtin.file:
        path: /usr/local/lib/docker/cli-plugins
        state: directory
        mode: '0755'
      tags: [deploy, docker, setup]

    - name: Install docker buildx plugin
      ansible.builtin.get_url:
        url: https://github.com/docker/buildx/releases/download/v0.19.3/buildx-v0.19.3.linux-amd64
        dest: /usr/local/lib/docker/cli-plugins/docker-buildx
        mode: '0755'
      tags: [deploy, docker, setup]

    - name: Ensure Docker service is running
      ansible.builtin.service:
        name: docker
        state: started
        enabled: yes
      tags: [deploy, docker, setup]

    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes
      tags: [deploy, docker, setup]

    - name: Generate SSL certificates if they don't exist
      ansible.builtin.shell:
        cmd: bash generate-ssl-cert.sh
        chdir: "{{ app_dir }}"
        creates: "{{ app_dir }}/certs/cert.pem"
      tags: [deploy, certs]

    - name: Stop existing containers
      ansible.builtin.shell:
        cmd: docker-compose down || true
        chdir: "{{ app_dir }}"
      ignore_errors: yes
      tags: [deploy, docker]

    - name: Build and start Docker containers
      ansible.builtin.shell:
        cmd: docker-compose up -d --build --force-recreate
        chdir: "{{ app_dir }}"
      tags: [deploy, docker]
      register: docker_output
      ignore_errors: yes

    - name: Check database container logs on failure
      ansible.builtin.shell:
        cmd: docker-compose logs db
        chdir: "{{ app_dir }}"
      when: docker_output.rc != 0
      register: db_logs

    - name: Display database logs
      ansible.builtin.debug:
        var: db_logs.stdout_lines
      when: docker_output.rc != 0

    - name: Fail if Docker containers didn't start
      ansible.builtin.fail:
        msg: "Docker containers failed to start. Check logs above."
      when: docker_output.rc != 0

    - name: Wait for application to be ready
      uri:
        url: "http://localhost:80"
        status_code: [200, 301, 302]
        validate_certs: no
      register: result
      until: result.status in [200, 301, 302]
      retries: 30
      delay: 2
      tags: [deploy, healthcheck]

    - name: Clean up old Docker images
      community.docker.docker_prune:
        images: true
        images_filters:
          dangling: true
      tags: [deploy, docker, cleanup]

    - name: Display deployment status
      debug:
        msg:
          - "=========================================="
          - "âœ… Deployment Complete!"
          - "=========================================="
          - "Application URL: {% if enable_ssl | bool %}https{% else %}http{% endif %}://{{ domain_name }}"
          - "Status: {{ result.status }}"
          - ""
          - "View logs: cd {{ app_dir }} && docker compose logs -f"
          - "=========================================="
      tags: [always]

