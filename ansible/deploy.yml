---
# Ansible playbook for deploying the application
# Usage: ansible-playbook ansible/deploy.yml

- name: Deploy Streamline Scheduler to VPS
  hosts: production
  become: yes
  gather_facts: yes

  tasks:
    - name: Install rsync on VPS
      ansible.builtin.package:
        name: rsync
        state: present
      tags: [deploy, setup]

    - name: Ensure application directory exists
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'
      tags: [deploy]

    - name: Copy application files to VPS
      ansible.posix.synchronize:
        src: "{{ playbook_dir }}/../"
        dest: "{{ app_dir }}/"
        delete: yes
        recursive: yes
        rsync_opts:
          - "--exclude=.git"
          - "--exclude=node_modules"
          - "--exclude=.next"
          - "--exclude=.env*"
          - "--exclude=ansible"
        dest_port: "{{ ansible_port }}"
      tags: [deploy]

    - name: Create .env.production file
      template:
        src: templates/env.production.j2
        dest: "{{ app_dir }}/.env.production"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'
      tags: [deploy, env]

    - name: Ensure Docker is installed
      ansible.builtin.package:
        name: docker.io
        state: present
      tags: [deploy, docker, setup]

    - name: Install docker-compose
      ansible.builtin.get_url:
        url: https://github.com/docker/compose/releases/latest/download/docker-compose-linux-x86_64
        dest: /usr/local/bin/docker-compose
        mode: '0755'
      tags: [deploy, docker, setup]

    - name: Ensure Docker service is running
      ansible.builtin.service:
        name: docker
        state: started
        enabled: yes
      tags: [deploy, docker, setup]

    - name: Add user to docker group
      ansible.builtin.user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes
      tags: [deploy, docker, setup]

    - name: Stop existing containers
      community.docker.docker_compose_v2:
        project_src: "{{ app_dir }}"
        state: absent
        docker_cli: /usr/bin/docker
      ignore_errors: yes
      tags: [deploy, docker]

    - name: Build and start Docker containers
      community.docker.docker_compose_v2:
        project_src: "{{ app_dir }}"
        build: always
        state: present
        pull: always
        recreate: always
        docker_cli: /usr/bin/docker
      tags: [deploy, docker]
      register: docker_output

    - name: Wait for application to be ready
      uri:
        url: "http://localhost:{{ app_port }}"
        status_code: 200
      register: result
      until: result.status == 200
      retries: 30
      delay: 2
      tags: [deploy, healthcheck]

    - name: Clean up old Docker images
      community.docker.docker_prune:
        images: true
        images_filters:
          dangling: true
      tags: [deploy, docker, cleanup]

    - name: Display deployment status
      debug:
        msg:
          - "=========================================="
          - "âœ… Deployment Complete!"
          - "=========================================="
          - "Application URL: {% if enable_ssl | bool %}https{% else %}http{% endif %}://{{ domain_name }}"
          - "Status: {{ result.status }}"
          - ""
          - "View logs: cd {{ app_dir }} && docker compose logs -f"
          - "=========================================="
      tags: [always]

